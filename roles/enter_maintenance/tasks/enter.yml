---
- name: Check if host can enter maintenance mode
  ansible.builtin.import_role:
    name: stackhpc.cephadm.commands
  vars:
    cephadm_commands:
      - "orch host ok-to-stop {{ cephadm_hostname }}"

# Annoyingly, 'ceph orch host ok-to-stop' does not exit non-zero when
# it is not OK to stop, so we need to check for specific messages.
- name: Assert that it is safe to stop host
  ansible.builtin.assert:
    that:
      # This one is seen for monitors
      - "'It is NOT safe' not in cephadm_commands_result.results[0].stderr"
      # This one is seen for OSDs
      - "'unsafe to stop' not in cephadm_commands_result.results[0].stderr"
    fail_msg: "{{ cephadm_commands_result.results[0].stderr }}"

- name: Fail over Ceph manager
  ansible.builtin.import_role:
    name: stackhpc.cephadm.commands
  vars:
    cephadm_commands:
      - "mgr fail"
  when: '"Cannot stop active Mgr daemon" in cephadm_commands_result.results[0].stderr'

- name: Ensure host is in maintenance mode
  ansible.builtin.import_role:
    name: stackhpc.cephadm.commands
  vars:
    cephadm_commands:
      - "orch host maintenance enter {{ cephadm_hostname }}"
