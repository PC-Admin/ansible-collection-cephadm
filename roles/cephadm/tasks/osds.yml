---

- name: Add OSDs individually
  command:
    cmd: >
         cephadm shell --
         ceph orch daemon add osd {{ ansible_facts.hostname }}:{{ item }}
  become: true
  register: osd_add_result
  changed_when: not osd_add_result.stdout.startswith("Created no osd(s) on host")
  delegate_to: "{{ omit if 'mons' in group_names else groups['mons'][0] }}"
  when: cephadm_osd_devices | length > 0
  with_items: "{{ cephadm_osd_devices }}"

- name: Add OSDs
  block:
  - name: Get cluster fsid
    command:
      cmd: "cephadm shell -- ceph fsid"
    when: cephadm_fsid | length == 0
    become: true
    register: cephadm_fsid_current
    changed_when: false

  - name: Template out osd_spec.yml
    vars:
      fsid: "{{ cephadm_fsid if cephadm_fsid | length > 0 else cephadm_fsid_current.stdout }}"
    copy:
      content: "{{ cephadm_osd_spec | to_nice_yaml if cephadm_osd_spec is mapping else cephadm_osd_spec }}"
      dest: "/var/run/ceph/{{ fsid }}/osd_spec.yml"
      owner: root
      group: root
      mode: 0644
    when: cephadm_osd_spec | length > 0
    become: true

  - name: Apply OSDs spec
    command:
      cmd: >
           cephadm shell --
           ceph orch apply -i /var/run/ceph/osd_spec.yml
    when: cephadm_osd_spec | length > 0
    become: true

  delegate_to: "{{ groups['mons'][0] }}"
  run_once: True
